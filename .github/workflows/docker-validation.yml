name: Docker Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: docker-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-and-validate:
    name: ðŸ³ Build & Validate Docker Image
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Docker image
        run: |
          docker build \
            --build-arg VITE_ENCRYPTION_KEY=ci-dummy-key \
            --tag kanban-app:ci-test \
            .

      - name: ðŸŒ Create Docker network
        run: docker network create kanban-test-net

      - name: ðŸ›¢ï¸ Start PostgreSQL container
        run: |
          docker run -d \
            --name test-postgres \
            --network kanban-test-net \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=kanban_test \
            postgres:17-alpine

      - name: â³ Wait for PostgreSQL to be ready
        run: |
          until docker exec test-postgres pg_isready -U postgres; do
            echo "Waiting for postgres..."
            sleep 2
          done

      - name: ðŸ‘¤ Create app_user in test database
        run: |
          docker exec test-postgres psql -U postgres -d kanban_test -c \
            "CREATE USER app_user WITH PASSWORD 'app_password'; GRANT CONNECT ON DATABASE kanban_test TO app_user;"

      - name: ðŸš€ Start application container
        run: |
          docker run -d \
            --name test-app \
            --network kanban-test-net \
            -p 3000 \
            -e DATABASE_URL=postgresql://app_user:app_password@test-postgres:5432/kanban_test \
            -e ADMIN_DATABASE_URL=postgresql://postgres:postgres@test-postgres:5432/kanban_test \
            -e BETTER_AUTH_SECRET=ci-secret-for-better-auth-minimum-32-chars \
            -e BETTER_AUTH_URL=http://localhost:3000 \
            -e NODE_ENV=production \
            kanban-app:ci-test

      - name: ðŸ”Œ Get dynamic application port
        id: get-port
        run: |
          APP_PORT=$(docker port test-app 3000 | cut -d: -f2)
          echo "app_port=$APP_PORT" >> $GITHUB_OUTPUT
          echo "App is available on port $APP_PORT"

      - name: ðŸ¥ Wait for application to be healthy
        run: |
          APP_PORT="${{ steps.get-port.outputs.app_port }}"
          for i in $(seq 1 30); do
            if curl -sf "http://localhost:${APP_PORT}/api/health"; then
              echo "Application is healthy"
              exit 0
            fi
            echo "Attempt $i/30: waiting for app..."
            sleep 3
          done
          echo "Application failed to become healthy"
          docker logs test-app
          exit 1

      - name: ðŸ§¹ Cleanup containers and network
        if: always()
        run: |
          docker stop test-app test-postgres 2>/dev/null || true
          docker rm test-app test-postgres 2>/dev/null || true
          docker network rm kanban-test-net 2>/dev/null || true

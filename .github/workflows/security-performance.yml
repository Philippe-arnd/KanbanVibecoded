name: Security & Performance

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: security-performance-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  secret-detection:
    name: ğŸ”‘ Secret Detection
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: ğŸ“¥ Checkout code (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ” Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ›¡ï¸ Run Semgrep
        id: semgrep
        uses: semgrep/semgrep-action@v1
        continue-on-error: true
        with:
          config: >-
            p/security-audit
            p/javascript
            p/react
            p/nodejs
            .semgrep.yml
          generateSarif: '1'

      - name: ğŸ“¤ Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

      - name: âŒ Fail if Semgrep found critical issues
        if: steps.semgrep.outcome == 'failure'
        run: |
          echo "Semgrep security scan failed with critical findings."
          exit 1

  bundle-size:
    name: ğŸ“¦ Bundle Size
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      js_kb: ${{ steps.bundle.outputs.js_kb }}
      css_kb: ${{ steps.bundle.outputs.css_kb }}
      js_limit_kb: ${{ steps.bundle.outputs.js_limit_kb }}
      css_limit_kb: ${{ steps.bundle.outputs.css_limit_kb }}
      js_pct: ${{ steps.bundle.outputs.js_pct }}
      css_pct: ${{ steps.bundle.outputs.css_pct }}
      js_warn: ${{ steps.bundle.outputs.js_warn }}
      css_warn: ${{ steps.bundle.outputs.css_warn }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          VITE_ENCRYPTION_KEY: ci-dummy-key

      - name: ğŸ“ Measure bundle size
        id: bundle
        run: |
          JS_LIMIT=600000
          CSS_LIMIT=80000
          JS_SIZE=$(find client/dist/assets -name '*.js' -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo 0)
          CSS_SIZE=$(find client/dist/assets -name '*.css' -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo 0)
          JS_KB=$(( JS_SIZE / 1024 ))
          CSS_KB=$(( CSS_SIZE / 1024 ))
          JS_LIMIT_KB=$(( JS_LIMIT / 1024 ))
          CSS_LIMIT_KB=$(( CSS_LIMIT / 1024 ))
          JS_PCT=$(( JS_SIZE * 100 / JS_LIMIT ))
          CSS_PCT=$(( CSS_SIZE * 100 / CSS_LIMIT ))
          JS_WARN=false
          CSS_WARN=false
          if [ "$JS_SIZE" -gt "$JS_LIMIT" ]; then
            echo "WARNING: JS bundle ${JS_KB} KB exceeds limit of ${JS_LIMIT_KB} KB"
            JS_WARN=true
          fi
          if [ "$CSS_SIZE" -gt "$CSS_LIMIT" ]; then
            echo "WARNING: CSS bundle ${CSS_KB} KB exceeds limit of ${CSS_LIMIT_KB} KB"
            CSS_WARN=true
          fi
          echo "js_kb=$JS_KB" >> $GITHUB_OUTPUT
          echo "css_kb=$CSS_KB" >> $GITHUB_OUTPUT
          echo "js_limit_kb=$JS_LIMIT_KB" >> $GITHUB_OUTPUT
          echo "css_limit_kb=$CSS_LIMIT_KB" >> $GITHUB_OUTPUT
          echo "js_pct=$JS_PCT" >> $GITHUB_OUTPUT
          echo "css_pct=$CSS_PCT" >> $GITHUB_OUTPUT
          echo "js_warn=$JS_WARN" >> $GITHUB_OUTPUT
          echo "css_warn=$CSS_WARN" >> $GITHUB_OUTPUT

  generate-report:
    name: ğŸ“‹ Security Report
    needs: [secret-detection, security-scan, bundle-size]
    if: always() && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ” Find existing PR comment
        id: find-comment
        uses: peter-evans/find-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- ci-security-report -->'

      - name: ğŸ’¬ Post security report comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- ci-security-report -->
            ## ğŸ” Security & Performance Report

            | Check | Status |
            |-------|--------|
            | ğŸ”‘ Secret Detection | ${{ needs.secret-detection.result == 'success' && 'âœ… Passed' || needs.secret-detection.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            | ğŸ›¡ï¸ Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || needs.security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            | ğŸ“¦ JS Bundle | ${{ needs.bundle-size.result == 'success' && (needs.bundle-size.outputs.js_warn == 'true' && format('âš ï¸ {0} KB / {1} KB ({2}%) â€” over limit', needs.bundle-size.outputs.js_kb, needs.bundle-size.outputs.js_limit_kb, needs.bundle-size.outputs.js_pct) || format('âœ… {0} KB / {1} KB ({2}%)', needs.bundle-size.outputs.js_kb, needs.bundle-size.outputs.js_limit_kb, needs.bundle-size.outputs.js_pct)) || 'â“ N/A' }} |
            | ğŸ¨ CSS Bundle | ${{ needs.bundle-size.result == 'success' && (needs.bundle-size.outputs.css_warn == 'true' && format('âš ï¸ {0} KB / {1} KB ({2}%) â€” over limit', needs.bundle-size.outputs.css_kb, needs.bundle-size.outputs.css_limit_kb, needs.bundle-size.outputs.css_pct) || format('âœ… {0} KB / {1} KB ({2}%)', needs.bundle-size.outputs.css_kb, needs.bundle-size.outputs.css_limit_kb, needs.bundle-size.outputs.css_pct)) || 'â“ N/A' }} |

      - name: âŒ Fail if blocking checks failed
        if: needs.secret-detection.result == 'failure' || needs.security-scan.result == 'failure'
        run: |
          echo "One or more blocking security checks failed."
          echo "Secret Detection: ${{ needs.secret-detection.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          exit 1

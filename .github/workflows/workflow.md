# CI/CD Workflow Architecture

This document describes the complete GitHub Actions CI/CD system for the kanban-app project.
<!-- auto-merge validation: 2026-02-14 -->

---

## Overview

The system consists of **6 workflow files** covering the full lifecycle from push to auto-merge.

```
Every push to main/dev
  â””â”€â”€ ci.yml                    (build check only)

Every PR targeting main (non-draft)
  â”œâ”€â”€ pr-validation.yml         (lint/build + vitest + RLS tests + coverage report)
  â”œâ”€â”€ security-performance.yml  (secrets, SAST, bundle size)
  â”œâ”€â”€ dependency-review.yml     (CVEs, license compliance)
  â””â”€â”€ docker-validation.yml     (Docker build + health, path-filtered)

When any of the above complete
  â””â”€â”€ auto-merge.yml            (squash merge if all 6 required checks pass)
```

---

## Workflow Details

### 1. `ci.yml` â€” ğŸ”§ CI (Build Check)

**Trigger:** Push or PR to `main` or `dev`
**Purpose:** Lightweight baseline check that runs on every push, including to the `dev` branch where PR-specific workflows don't apply.

| Step | Detail |
|------|--------|
| ğŸ“¥ Checkout | `actions/checkout@v4` |
| âš™ï¸ Node setup | Node 24, npm cache |
| ğŸ“¦ Install | `npm ci` |
| ğŸ—ï¸ Build | `npm run build` with `VITE_ENCRYPTION_KEY=ci-dummy-key` |

**Note:** No test suite here â€” full testing is handled by `pr-validation.yml`. This workflow just confirms the Vite build doesn't break.

---

### 2. `pr-validation.yml` â€” PR Validation

**Trigger:** PR opened/synchronized/reopened/ready-for-review targeting `main`
**Skip condition:** Draft PRs (`github.event.pull_request.draft == false`)
**Concurrency:** One run per PR, cancels in-progress runs on new pushes

Four jobs run in this workflow, three of them in parallel:

```
âœ… Quick Checks  â”€â”€â”
ğŸ§ª Vitest Tests  â”€â”€â”¤â”€â”€â–º ğŸ“Š Test Report (PR comment)
ğŸ”’ RLS Tests     â”€â”€â”˜
```

#### Job 1 â€” âœ… Quick Checks (timeout: 5m)

Runs in parallel with jobs 2 and 3.

| Step | Command |
|------|---------|
| ğŸ” Lint | `npm run lint` |
| ğŸ—ï¸ Build | `npm run build` (VITE_ENCRYPTION_KEY=ci-dummy-key) |

#### Job 2 â€” ğŸ§ª Vitest Tests (timeout: 10m)

Spins up a real `postgres:17-alpine` service container.

**Database setup sequence:**
1. Create `app_user` (non-superuser) â€” required so RLS policies are actually enforced
2. Run schema migrations: `npx drizzle-kit push --config=server/drizzle.config.js --force`
3. Grant `app_user` table-level permissions (SELECT, INSERT, UPDATE, DELETE + sequences)
4. Apply RLS policies: `node server/db/apply-rls.js`

**Why two DB users?**
PostgreSQL superusers bypass RLS by default. Tests connect as `app_user` (non-superuser) so RLS is enforced. Migrations run as `postgres` (superuser) via `ADMIN_DATABASE_URL`.

**Test execution:**
- Vitest suite: `npm run test:coverage` (connects as `app_user`)

**Coverage:**
- Parses `coverage/coverage-summary.json` (generated by `@vitest/coverage-v8` with the `json-summary` reporter)
- Extracts lines, statements, functions, and branches percentages
- **Uploads the full `coverage/` directory as a downloadable artifact** (`coverage-report`, retained 7 days)
- Job outputs the parsed metrics so the `report` job can include them in the PR comment

#### Job 3 â€” ğŸ”’ RLS Tests (timeout: 10m)

Also spins up its own `postgres:17-alpine` service container (runs in parallel with job 2).

**Test execution:**
- RLS tests: `node --test server/tests/test-rls.js` (uses Node's native `node:test`, NOT vitest)

Both test jobs use `set +e` to capture exit codes without immediately failing, then explicitly fail at the end if the exit code was non-zero.

#### Job 4 â€” ğŸ“Š Test Report (`needs: [quick-checks, vitest-tests, rls-tests]`, `if: always()`)

Posts/updates a single comment (sentinel: `<!-- ci-test-results -->`) via `peter-evans/find-comment@v3` + `peter-evans/create-or-update-comment@v4`.

**The comment includes:**
- Status table for all 3 check jobs (Lint & Build, Vitest Tests, RLS Tests)
- Coverage breakdown (Lines, Statements, Functions, Branches percentages)
- ğŸ“¥ Direct link to the workflow run where the coverage artifact can be downloaded

---

### 3. `security-performance.yml` â€” Security & Performance

**Trigger:** PR opened/synchronized/reopened/ready-for-review targeting `main`
**Skip condition:** Draft PRs
**Concurrency:** One run per PR, cancels in-progress runs

Four jobs run; the last consolidates results into a PR comment:

```
ğŸ”‘ Secret Detection  â”€â”€â”
ğŸ›¡ï¸ Security Scan     â”€â”€â”¤â”€â”€â–º ğŸ“‹ Security Report (PR comment)
ğŸ“¦ Bundle Size       â”€â”€â”˜
```

#### Job 1 â€” ğŸ”‘ Secret Detection (timeout: 2m, BLOCKING)

- Uses `gitleaks/gitleaks-action@v2` with config from `.gitleaks.toml`
- Checks out with `fetch-depth: 0` (full git history, so secrets in prior commits on the branch are caught)
- Failure here blocks the PR

#### Job 2 â€” ğŸ›¡ï¸ Security Scan (timeout: 3m, BLOCKING on critical)

- Runs Semgrep (`semgrep/semgrep-action@v1`) with:
  - Community rulesets: `p/security-audit`, `p/javascript`, `p/react`, `p/nodejs`
  - Custom rules from `.semgrep.yml` (10 rules covering weak hashes, hardcoded secrets, XSS, SQLi, insecure cookies, Math.random in crypto contexts, sensitive localStorage usage)
- Generates SARIF output uploaded to GitHub Security tab (`github/codeql-action/upload-sarif@v3`)
- `continue-on-error: true` on the Semgrep step so SARIF upload always runs; a separate step then explicitly fails if Semgrep's outcome was failure

#### Job 3 â€” ğŸ“¦ Bundle Size (timeout: 5m, NON-BLOCKING)

- Builds the Vite app, measures total JS and CSS sizes in `client/dist/assets/`
- Limits: JS â‰¤ 600 KB, CSS â‰¤ 80 KB
- Emits warnings but does NOT fail the workflow
- Outputs sizes in **KB** (not raw bytes) plus percentage-of-limit for readability

#### Job 4 â€” ğŸ“‹ Security Report (`needs: [secret-detection, security-scan, bundle-size]`, `if: always()`)

- Consolidates all results into a PR comment (sentinel: `<!-- ci-security-report -->`)
- Bundle sizes displayed as `X KB / Y KB (Z%)` â€” e.g. `âœ… 511 KB / 600 KB (85%)`
- **Fails this job** if secret-detection or security-scan result is `failure`, making the overall workflow fail

---

### 4. `dependency-review.yml` â€” Dependency Review

**Trigger:** Any PR targeting `main` (no draft filter â€” runs on all PRs including drafts)
**Permissions:** `contents: read`, `pull-requests: write`

Uses GitHub's official `actions/dependency-review-action@v4`:

| Setting | Value |
|---------|-------|
| Fail on severity | `high` |
| Vulnerability check | enabled |
| License check | enabled |
| Allowed licenses | MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD |
| OpenSSF scorecard warning | level 3 and below |
| PR comment | always |

Posts a summary directly to the PR. Fails the workflow on any high/critical CVE in added/changed dependencies.

---

### 5. `docker-validation.yml` â€” Docker Validation

**Trigger:** PR targeting `main`, but **only when these paths change:**
- `Dockerfile`
- `docker-compose*.yml`
- `.dockerignore`

**Skip condition:** Draft PRs
**Concurrency:** One run per PR, cancels in-progress runs
**Timeout:** 15 minutes

**Build and validation sequence:**
1. `docker/setup-buildx-action@v3`
2. `docker build --build-arg VITE_ENCRYPTION_KEY=ci-dummy-key --tag kanban-app:ci-test .`
3. Create isolated Docker network `kanban-test-net`
4. Start `postgres:17-alpine` on the network
5. Wait for `pg_isready` inside the container
6. Create `app_user` in the test database
7. Start the app container with `-p 3000` (no fixed host port â€” compliant with Coolify constraint)
8. Retrieve dynamic port: `docker port test-app 3000 | cut -d: -f2`
9. Poll `GET /api/health` up to 30 times (3s intervals) â€” fails if never healthy
10. Cleanup (`if: always()`) â€” stops and removes both containers and the network

**Why no fixed port?** The `docker-compose.yml` must not have fixed host port mappings to stay compatible with Coolify's routing. This workflow mirrors that constraint.

---

### 6. `auto-merge.yml` â€” Auto Merge

**Trigger:** `workflow_run` completed for any of: `PR Validation`, `Security & Performance`, `Dependency Review`, `Docker Validation`

This means auto-merge is re-evaluated every time any of the four upstream workflows finishes.

**Permissions:** `contents: write`, `pull-requests: write`, `checks: read`

**Logic (runs only if triggering workflow succeeded):**

```
1. Find open PR for the branch targeting main
   - Skip: no PR found
   - Skip: PR is a draft
   - Skip: PR has conflicts (mergeable == CONFLICTING)

2. Check all 6 required checks via `gh pr checks`:
   - "âœ… Quick Checks"
   - "ğŸ§ª Vitest Tests"
   - "ğŸ”’ RLS Tests"
   - "ğŸ”‘ Secret Detection"
   - "ğŸ›¡ï¸ Security Scan"
   - "ğŸ” Review Dependencies for Vulnerabilities"

3. If all 6 are SUCCESS:
   - gh pr merge <number> --squash --auto
   - Post confirmation comment on PR

4. Otherwise: exit silently (will re-evaluate on next workflow_run)
```

**Note:** "ğŸ³ Build & Validate Docker Image" is NOT in the required checks list. Docker Validation only runs when Docker-related files change, so it would block auto-merge on unrelated PRs if included.

---

## Supporting Config Files

### `.gitleaks.toml`

Global allowlist covers:
- **Paths:** `*.md`, `*.test.*`, `*.spec.*`, `server/tests/`, `.env.example`
- **Regexes:** test/placeholder/example/dummy/ci prefixed values, `localhost` URLs, CI postgres connection strings, `${{ ... }}` GitHub Actions expressions

Three custom rules with allowlists:
- `generic-api-key` â€” detects `api_key = "..."` patterns
- `jwt-better-auth-secret` â€” detects `BETTER_AUTH_SECRET = "..."` patterns
- `database-url-with-credentials` â€” detects non-localhost `postgres://user:pass@host` patterns

### `.semgrep.yml`

10 custom security rules for JavaScript:

| Rule ID | Severity | CWE |
|---------|----------|-----|
| `weak-hash-md5` | WARNING | CWE-327 |
| `weak-hash-sha1` | WARNING | CWE-327 |
| `hardcoded-secret-assignment` | ERROR | CWE-798 |
| `insecure-cookie-secure-false` | WARNING | CWE-614 |
| `insecure-cookie-httponly-false` | WARNING | CWE-1004 |
| `sql-injection-string-concat` | ERROR | CWE-89 |
| `xss-innerhtml` | WARNING | CWE-79 |
| `xss-dangerously-set-inner-html` | WARNING | CWE-79 |
| `insecure-math-random-security` | ERROR | CWE-338 |
| `sensitive-data-localstorage-password` | ERROR | CWE-312 |

### `.semgrepignore`

Excludes from Semgrep scans: `node_modules/`, `dist/`, `client/dist/`, `server/tests/`, `*.test.*`, `server/drizzle/`, `coverage/`

---

## Required Checks for Auto-Merge

All **6** check names must be `SUCCESS`:

| Check Name | Source Workflow | Job |
|------------|----------------|-----|
| âœ… Quick Checks | PR Validation | `quick-checks` |
| ğŸ§ª Vitest Tests | PR Validation | `vitest-tests` |
| ğŸ”’ RLS Tests | PR Validation | `rls-tests` |
| ğŸ”‘ Secret Detection | Security & Performance | `secret-detection` |
| ğŸ›¡ï¸ Security Scan | Security & Performance | `security-scan` |
| ğŸ” Review Dependencies for Vulnerabilities | Dependency Review | `dependency-review` |

Docker Validation (`ğŸ³ Build & Validate Docker Image`) is intentionally excluded â€” it only runs on Docker-related file changes and would block unrelated PRs.

---

## PR Comments & Artifacts

Each workflow that posts PR comments uses an HTML comment as a sentinel so the comment is updated in-place rather than duplicated on every push:

| Sentinel | Workflow | Content |
|----------|---------|---------|
| `<!-- ci-test-results -->` | PR Validation | Suite status, coverage metrics, artifact link |
| `<!-- ci-security-report -->` | Security & Performance | Security check status, bundle sizes in KB with % of limit |

Dependency Review uses the built-in comment feature of `actions/dependency-review-action` (no custom sentinel needed).

### Coverage Artifact

The `ğŸ§ª Vitest Tests` job uploads the full `coverage/` directory as a **downloadable artifact** named `coverage-report` (retained 7 days). The PR comment includes a direct link to the workflow run where it can be downloaded.

---

## Environment Variables Used in CI

| Variable | Value in CI | Purpose |
|----------|-------------|---------|
| `VITE_ENCRYPTION_KEY` | `ci-dummy-key` | Required by Vite build (client-side crypto) |
| `DATABASE_URL` | `postgresql://app_user:app_password@localhost:5432/kanban_test` | Non-superuser connection (RLS enforced) |
| `ADMIN_DATABASE_URL` | `postgresql://postgres:postgres@localhost:5432/kanban_test` | Superuser connection (migrations, RLS setup) |
| `BETTER_AUTH_SECRET` | `ci-secret-for-better-auth-minimum-32-chars` | Must be 32+ chars â€” shorter values crash the auth module |
| `BETTER_AUTH_URL` | `http://localhost:3000` | Auth base URL |
| `GITHUB_TOKEN` | Injected by GitHub | Used by gitleaks, auto-merge, dependency review |

---

## Concurrency Behaviour

Three workflows use `cancel-in-progress: true` grouped by PR number:
- `pr-validation-<PR_NUMBER>`
- `security-performance-<PR_NUMBER>`
- `docker-validation-<PR_NUMBER>`

This means pushing a new commit to a PR while CI is running immediately cancels the in-progress run and starts a fresh one. `dependency-review.yml` relies on the GitHub Action's own concurrency handling.

---

## Action Versions Reference

| Action | Version |
|--------|---------|
| `actions/checkout` | `@v4` |
| `actions/setup-node` | `@v4` |
| `actions/upload-artifact` | `@v4` |
| `actions/dependency-review-action` | `@v4` |
| `docker/setup-buildx-action` | `@v3` |
| `gitleaks/gitleaks-action` | `@v2` |
| `semgrep/semgrep-action` | `@v1` |
| `github/codeql-action/upload-sarif` | `@v3` |
| `peter-evans/find-comment` | `@v3` |
| `peter-evans/create-or-update-comment` | `@v4` |
